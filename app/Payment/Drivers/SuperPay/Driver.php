<?php

declare(strict_types=1);

namespace App\Payment\Drivers\SuperPay;

use App\Common\Response;
use App\Payment\Contracts\DriverPaymentInterface;
use App\Payment\Drivers\AbstractDriver;
use Hyperf\HttpServer\Contract\RequestInterface;
use Psr\Http\Message\ResponseInterface;

use function Hyperf\Support\make;

class Driver extends AbstractDriver implements DriverPaymentInterface
{
    // 代收銀行代碼轉換
    protected const array BANK_CODE_MAP = [
        '001' => '001',
        '002' => '002',
        '003' => '003',
        '004' => '004',
        '005' => '005',
        '006' => '006',
        '007' => '007',
        '008' => '008',
        '009' => '009',
        '010' => '010',
        '011' => '011',
        '012' => '012',
        '013' => '013',
        '014' => '014',
        '015' => '015',
        '016' => '016',
        '017' => '017',
        '018' => '018',
        '019' => '019',
        '020' => '020',
        '021' => '021',
        '022' => '022',
        '023' => '023',
        '024' => '024',
        '025' => '025',
        '026' => '026',
        '027' => '232',
        '028' => '030',
        '029' => '091',
        '030' => '039',
        '031' => '101',
        '032' => '176',
        '033' => '033',
        '034' => '058',
        '035' => '111',
        '036' => '063',
        '037' => '064',
        '038' => '#N/A',
        '039' => '137',
        '040' => '079',
        '041' => '038',
        '042' => '020',
        '043' => '177',
        '044' => '#N/A',
        '045' => '#N/A',
        '046' => '125',
        '047' => '#N/A',
        '048' => '273',
        '049' => '027',
        '050' => '053',
        '051' => '034',
        '052' => '#N/A',
        '053' => '156',
        '054' => '087',
        '055' => '071',
        '056' => '112',
        '057' => '215',
        '058' => '045',
        '059' => '#N/A',
        '060' => '150',
        '061' => '067',
        '062' => '062',
        '063' => '051',
        '064' => '236',
        '065' => '065',
        '066' => '148',
        '067' => '158',
        '068' => '289',
        '069' => '#N/A',
        '070' => '055',
        '071' => '211',
        '072' => '#N/A',
        '073' => '217',
        '074' => '#N/A',
        '075' => '081',
        '076' => '220',
        '077' => '121',
        '078' => '#N/A',
        '079' => '100',
        '080' => '086',
        '081' => '056',
        '082' => '221',
        '083' => '239',
        '084' => '119',
        '085' => '065',
        '086' => '043',
        '087' => '224',
        '088' => '#N/A',
        '089' => '044',
        '090' => '066',
        '091' => '035',
        '092' => '#N/A',
        '093' => '075',
        '094' => '115',
        '095' => '#N/A',
        '096' => '021',
        '097' => '#N/A',
        '098' => '032',
        '099' => '037',
        '100' => '174',
        '101' => '#N/A',
        '102' => '060',
        '103' => '240',
        '104' => '130',
        '105' => '114',
        '106' => '116',
        '107' => '065',
        '108' => '149',
        '109' => '186',
        '110' => '050',
        '111' => '078',
        '112' => '076',
        '113' => '029',
        '114' => '#N/A',
        '115' => '059',
        '116' => '153',
        '117' => '209',
        '118' => '#N/A',
        '119' => '138',
        '120' => '117',
        '121' => '#N/A',
        '122' => '098',
        '123' => '072',
        '124' => '#N/A',
        '125' => '207',
        '126' => '195',
        '127' => '028',
        '128' => '#N/A',
        '129' => '#N/A',
        '130' => '031',
        '131' => '118',
        '132' => '042',
        '133' => '#N/A',
        '134' => '175',
        '135' => '#N/A',
        '136' => '#N/A',
        '137' => '140',
        '138' => '#N/A',
        '139' => '#N/A',
        '140' => '234',
        '141' => '048',
        '142' => '241',
        '143' => '104',
        '144' => '#N/A',
        '145' => '187',
        '146' => '#N/A',
        '147' => '040',
        '148' => '074',
        '149' => '272',
        '150' => '198',
        '151' => '267',
        '152' => '107',
        '153' => '085',
        '154' => '#N/A',
        '155' => '#N/A',
        '156' => '#N/A',
        '157' => '#N/A',
        '158' => '#N/A',
        '159' => '080',
        '160' => '#N/A',
        '161' => '#N/A',
        '162' => '#N/A',
        '163' => '#N/A',
        '164' => '#N/A',
        '165' => '#N/A',
        '166' => '068',
        '167' => '#N/A',
        '168' => '047',
        '169' => '168',
        '170' => '052',
        '171' => '237',
        '172' => '113',
        '173' => '161',
        '174' => '#N/A',
        '175' => '210',
        '176' => '041',
        '177' => '#N/A',
        '178' => '#N/A',
        '180' => '146',
        '181' => '248',
        '182' => '185',
        '183' => '#N/A',
        '184' => '#N/A',
        '185' => '#N/A',
        '187' => '#N/A',
        '188' => '#N/A',
        '189' => '127',
        '190' => '#N/A',
        '191' => '054',
        '192' => '093',
        '193' => '135',
        '194' => '141',
        '195' => '#N/A',
        '196' => '261',
        '197' => '#N/A',
        '198' => '#N/A',
        '199' => '#N/A',
        '200' => '#N/A',
        '201' => '#N/A',
        '202' => '126',
        '203' => '046',
        '204' => '#N/A',
        '205' => '057',
        '206' => '169',
        '207' => '196',
        '208' => '#N/A',
        '209' => '190',
        '210' => '#N/A',
        '211' => '#N/A',
        '212' => '#N/A',
        '214' => '#N/A',
        '215' => '049',
        '216' => '#N/A',
        '217' => '#N/A',
        '218' => '#N/A',
        '219' => '#N/A',
        '220' => '#N/A',
        '222' => '216',
        '223' => '061',
        '224' => '097',
        '225' => '#N/A',
        '226' => '#N/A',
        '227' => '#N/A',
        '228' => '#N/A',
        '229' => '#N/A',
        '230' => '252',
        '231' => '#N/A',
        '232' => '#N/A',
        '233' => '#N/A',
        '234' => '#N/A',
        '235' => '229',
        '236' => '#N/A',
        '237' => '#N/A',
        '238' => '#N/A',
        '239' => '#N/A',
        '240' => '#N/A',
        '241' => '128',
        '242' => '#N/A',
        '243' => '#N/A',
        '244' => '#N/A',
        '245' => '#N/A',
        '246' => '#N/A',
        '247' => '#N/A',
        '248' => '#N/A',
        '249' => '#N/A',
        '250' => '#N/A',
        '251' => '#N/A',
        '252' => '#N/A',
        '253' => '#N/A',
        '254' => '#N/A',
        '255' => '#N/A',
        '256' => '#N/A',
        '257' => '214',
        '258' => '#N/A',
        '259' => '#N/A',
        '260' => '#N/A',
        '261' => '105',
        '263' => '#N/A',
        '264' => '103',
        '265' => '139',
        '266' => '#N/A',
        '267' => '#N/A',
        '270' => '260',
        '271' => '253',
        '272' => '#N/A',
        '273' => '#N/A',
        '274' => '#N/A',
        '275' => '#N/A',
        '277' => '#N/A',
        '278' => '#N/A',
        '279' => '144',
        '280' => '#N/A',
        '281' => '#N/A',
        '283' => '#N/A',
        '284' => '#N/A',
        '285' => '159',
        '286' => '#N/A',
        '287' => '#N/A',
        '288' => '#N/A',
        '289' => '#N/A',
        '290' => '#N/A',
        '291' => '249',
        '292' => '#N/A',
        '293' => '255',
        '294' => '#N/A',
        '295' => '#N/A',
        '296' => '#N/A',
        '297' => '#N/A',
        '298' => '#N/A',
        '299' => '#N/A',
        '300' => '#N/A',
        '301' => '#N/A',
        '302' => '#N/A',
        '303' => '173',
        '304' => '155',
        '305' => '#N/A',
        '306' => '#N/A',
        '307' => '#N/A',
        '308' => '#N/A',
        '309' => '#N/A',
        '310' => '#N/A',
        '311' => '#N/A',
        '312' => '280',
        '313' => '#N/A',
        '314' => '#N/A',
        '315' => '#N/A',
        '316' => '#N/A',
        '317' => '#N/A',
        '318' => '#N/A',
        '319' => '#N/A',
        '320' => '#N/A',
        '321' => '#N/A',
        '322' => '#N/A',
        '323' => '#N/A',
        '324' => '#N/A',
        '325' => '#N/A',
        '326' => '182',
        '327' => '#N/A',
        '328' => '266',
        '329' => '#N/A',
        '330' => '#N/A',
        '331' => '#N/A',
        '332' => '#N/A',
        '333' => '#N/A',
        '334' => '#N/A',
        '335' => '#N/A',
        '336' => '#N/A',
        '337' => '#N/A',
        '338' => '#N/A',
        '339' => '#N/A',
        '340' => '#N/A',
        '341' => '#N/A',
        '342' => '#N/A',
        '343' => '#N/A',
        '344' => '208',
        '345' => '#N/A',
        '346' => '276',
        '347' => '#N/A',
        '348' => '#N/A',
        '349' => '#N/A',
        '350' => '#N/A',
        '351' => '#N/A',
        '352' => '#N/A',
        '353' => '#N/A',
        '354' => '#N/A',
        '355' => '#N/A',
        '356' => '#N/A',
        '357' => '247',
        '358' => '250',
        '359' => '#N/A',
        '360' => '#N/A',
        '361' => '#N/A',
        '362' => '#N/A',
        '363' => '#N/A',
        '364' => '#N/A',
        '365' => '290',
        '366' => '#N/A',
        '367' => '#N/A',
        '368' => '#N/A',
        '369' => '#N/A',
        '370' => '#N/A',
        '371' => '#N/A',
        '372' => '#N/A',
        '373' => '#N/A',
        '374' => '#N/A',
        '375' => '#N/A',
        '376' => '#N/A',
        '377' => '#N/A',
        '378' => '#N/A',
        '379' => '#N/A',
        '380' => '#N/A',
        '381' => '#N/A',
        '382' => '#N/A',
        '383' => '#N/A',
        '384' => '#N/A',
        '385' => '#N/A',
        '386' => '#N/A',
        '387' => '#N/A',
        '388' => '#N/A',
        '389' => '204',
        '390' => '223',
        '391' => '#N/A',
        '392' => '#N/A',
        '393' => '268',
        '394' => '#N/A',
        '395' => '#N/A',
        '396' => '#N/A',
        '397' => '#N/A',
        '398' => '#N/A',
        '399' => '#N/A',
        '400' => '#N/A',
        '401' => '#N/A',
        '402' => '#N/A',
        '403' => '#N/A',
        '404' => '#N/A',
        '405' => '#N/A',
        '406' => '#N/A',
        '407' => '#N/A',
        '408' => '#N/A',
        '409' => '#N/A',
        '410' => '284',
        '411' => '#N/A',
        '412' => '#N/A',
        '413' => '#N/A',
        '414' => '#N/A',
        '415' => '#N/A',
        '416' => '#N/A',
        '417' => '#N/A',
        '418' => '#N/A',
        '419' => '#N/A',
        '420' => '#N/A',
        '421' => '#N/A',
        '422' => '#N/A',
        '423' => '#N/A',
        '424' => '#N/A',
        '425' => '#N/A',
        '426' => '#N/A',
        '427' => '#N/A',
        '428' => '#N/A',
        '429' => '#N/A',
        '430' => '#N/A',
        '431' => '#N/A',
        '432' => '#N/A',
        '433' => '#N/A',
        '434' => '108',
        '435' => '#N/A',
        '436' => '#N/A',
        '437' => '#N/A',
        '438' => '#N/A',
        '439' => '#N/A',
        '440' => '#N/A',
        '441' => '073',
        '442' => '#N/A',
        '443' => '#N/A',
        '444' => '#N/A',
        '445' => '#N/A',
        '446' => '#N/A',
        '447' => '#N/A',
        '448' => '#N/A',
        '449' => '#N/A',
        '450' => '#N/A',
        '451' => '#N/A',
        '452' => '122',
        '453' => '#N/A',
        '454' => '#N/A',
        '455' => '#N/A',
        '456' => '#N/A',
        '457' => '#N/A',
        '458' => '#N/A',
        '459' => '#N/A',
        '460' => '#N/A',
        '461' => '#N/A',
        '462' => '095',
        '463' => '#N/A',
        '464' => '#N/A',
        '465' => '#N/A',
        '466' => '#N/A',
        '467' => '#N/A',
        '468' => '#N/A',
        '469' => '170',
        '470' => '#N/A',
        '471' => '#N/A',
        '472' => '#N/A',
        '473' => '#N/A',
        '474' => '#N/A',
        '475' => '242',
        '476' => '#N/A',
        '477' => '#N/A',
        '478' => '294',
        '479' => '#N/A',
        '480' => '#N/A',
        '481' => '#N/A',
        '482' => '#N/A',
        '483' => '#N/A',
        '484' => '#N/A',
        '485' => '225',
        '486' => '#N/A',
        '487' => '#N/A',
        '488' => '#N/A',
        '489' => '#N/A',
        '490' => '#N/A',
        '491' => '#N/A',
        '492' => '#N/A',
        '493' => '#N/A',
        '494' => '#N/A',
        '495' => '129',
        '496' => '#N/A',
        '497' => '089',
        '498' => '165',
        '499' => '#N/A',
        '500' => '#N/A',
        '501' => '#N/A',
        '502' => '#N/A',
        '503' => '#N/A',
        '504' => '#N/A',
        '505' => '#N/A',
        '506' => '#N/A',
        '507' => '#N/A',
        '508' => '#N/A',
        '509' => '#N/A',
        '510' => '#N/A',
        '511' => '#N/A',
        '512' => '#N/A',
        '513' => '#N/A',
        '514' => '#N/A',
        '515' => '#N/A',
        '516' => '#N/A',
        '517' => '228',
        '518' => '#N/A',
        '519' => '#N/A',
        '520' => '#N/A',
        '521' => '#N/A',
        '522' => '#N/A',
        '523' => '#N/A',
        '524' => '#N/A',
        '525' => '#N/A',
        '526' => '#N/A',
        '527' => '230',
        '528' => '#N/A',
        '529' => '180',
        '530' => '#N/A',
        '531' => '#N/A',
        '532' => '#N/A',
        '533' => '#N/A',
        '534' => '#N/A',
        '535' => '#N/A',
        '536' => '#N/A',
        '537' => '#N/A',
        '538' => '#N/A',
        '539' => '#N/A',
        '540' => '#N/A',
        '541' => '#N/A',
        '542' => '#N/A',
        '543' => '#N/A',
        '544' => '#N/A',
        '545' => '#N/A',
        '546' => '#N/A',
        '547' => '#N/A',
        '548' => '#N/A',
        '549' => '#N/A',
        '550' => '235',
        '551' => '#N/A',
        '552' => '#N/A',
        '553' => '#N/A',
        '554' => '#N/A',
        '555' => '#N/A',
        '556' => '#N/A',
        '557' => '#N/A',
        '558' => '#N/A',
        '559' => '179',
        '560' => '132',
        '561' => '#N/A',
        '562' => '#N/A',
        '563' => '#N/A',
        '564' => '#N/A',
        '565' => '#N/A',
        '566' => '#N/A',
        '567' => '#N/A',
        '568' => '#N/A',
        '569' => '263',
        '570' => '#N/A',
        '571' => '#N/A',
        '572' => '#N/A',
        '573' => '#N/A',
        '574' => '#N/A',
        '575' => '#N/A',
        '576' => '#N/A',
        '577' => '#N/A',
        '578' => '#N/A',
        '999' => '#N/A',
    ];

    /**
     * ============================================
     *  三方配置
     * ============================================
     */
    protected bool $amountToDollar = true; // 分=false 元=true

    protected string $signField = 'SIGNED_MSG';

    protected string $notifySuccessText = 'OK';

    protected string $notifyFailText = 'FAIL';

    /**
     * ============================================
     *  代收接口
     * ============================================
     */

    /**
     * 创建代收订单, 返回支付网址
     */
    public function orderCreate(RequestInterface $request): ResponseInterface
    {
        return make(OrderCreate::class, ['config' => $this->config])->request($request);
    }

    /**
     * 三方回調通知, 更新訂單
     */
    public function orderNotify(RequestInterface $request): ResponseInterface
    {
        return make(OrderNotify::class, ['config' => $this->config])->request($request);
    }

    /**
     * 查詢訂單(交易), 返回訂單明細
     */
    public function orderQuery(RequestInterface $request): ResponseInterface
    {
        return make(OrderQuery::class, ['config' => $this->config])->request($request);
    }

    /**
     * [Mock] 返回三方渠道回调参数
     */
    public function mockNotify(string $orderNo): ResponseInterface
    {
        return make(MockNotify::class, ['config' => $this->config])->request($orderNo);
    }

    /**
     * [Mock] 返回集成网关查询订单参数
     */
    public function mockQuery(string $orderNo): ResponseInterface
    {
        return Response::error(__METHOD__ . ' not implemented', 501);
    }

    /**
     * ============================================
     *  商戶接口
     * ============================================
     */

    /**
     * 查詢商戶餘額
     */
    public function balance(RequestInterface $request)
    {
        return make(Balance::class, ['config' => $this->config])->request($request);
    }

    /**
     * 代收: 转换三方订单状态, 返回统一的状态码到集成网关
     */
    public function transformStatus($status): string
    {
        // 三方支付状态: 0=未處理, 1=成功，未返回, SUCCESS=成功, FAILED=失敗, 4=失敗，金額不符, 5=訂單異常
        // 集成订单状态: 0=失败, 1=待付款, 2=支付成功, 3=金額調整, 4=交易失敗, 5=逾期失效
        return match ($status) {
            'SUCCESS' => '2',
            default => '0',
        };
    }

    /**
     * 代付: 转换三方订单状态, 返回统一的状态码到集成网关
     */
    public function transformWithdrawStatus($status): string
    {
        // 三方支付状态: 0=未處理, 1=處理中, 2=已出款, 3=已駁回, 4=核實不成功, 5=餘額不足
        // 集成订单状态: 0=預約中, 1=待處理, 2=執行中, 3=成功, 4=取消, 5=失敗, 6=審核中

        return match ($status) {
            0, 1, => '2',
            2 => '3',
            default => '5',
        };
    }

    /**
     * ============================================
     *  支付渠道共用方法
     * ============================================
     */

    /**
     * 通知三方回調結果
     */
    public function responsePlatform(string $code = ''): ResponseInterface
    {
        // 集成网关返回
        if ('00' != $code) {
            return response()->raw($this->notifyFailText);
        }

        return response()->raw($this->notifySuccessText);
    }

    /**
     * 簽名規則
     */
    protected function getSignature(array $data, string $signatureKey): string
    {
        if (isset($data[$this->signField])) {
            unset($data[$this->signField]);
        }

        if (isset($data['sign'])) {
            unset($data['sign']);
        }

        // 1. 字典排序
        ksort($data);

        // 2. 排除空值欄位參與簽名
        $data = array_filter($data);

        // 3. $tempData 轉成字串
        $tempStr = http_build_query($data, '', '&', PHP_QUERY_RFC3986);

        // 4. 反轉譯字串
        $tempStr = urldecode($tempStr);

        // 5. $tempStr 拼接密鑰
        $tempStr .= $signatureKey;

        // 6. MD5 並轉大寫
        return md5($tempStr);
    }
}
