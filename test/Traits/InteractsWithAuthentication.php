<?php

declare(strict_types=1);

namespace HyperfTest\Traits;

use App\Model\BackendUser;
use App\Model\User;
use GuzzleHttp\Psr7\ServerRequest;
use Hyperf\Context\Context;
use Hyperf\Stringable\Str;
use HyperfExtension\Jwt\Contracts\JwtFactoryInterface;
use Psr\Http\Message\ServerRequestInterface;

use function Hyperf\Support\make;

trait InteractsWithAuthentication
{
    protected string $token = '';

    /**
     * 在測試中登入用戶
     *
     * @return string jwt token
     */
    public function loginAs(User $user): string
    {
        Context::set(ServerRequestInterface::class, new ServerRequest('GET', env('APP_HOST') . '/api/v1'));
        $jwt = make(JwtFactoryInterface::class)->make();
        $this->token = $jwt->fromUser($user);
        $user->token = $this->token;
        $user->save();

        return $this->token;
    }

    /**
     * 以 userId 登入用戶
     *
     * @param string $userId
     *
     * @return string jwt token
     */
    public function loginByUserId($userId = '')
    {
        if (empty($userId)) {
            $userId = Str::uuid()->toString();
        }

        $user = User::find($userId);

        if (!$user) {
            $user = factory(User::class)->create([
                'id' => $userId,
            ]);
        }

        return $this->loginAs($user);
    }

    /**
     * 登入後台
     */
    public function loginBackendUser()
    {
        // Context::set(ServerRequestInterface::class, new ServerRequest('GET', env('APP_HOST') . '/api/v1'));
        // $jwt = make(JwtFactoryInterface::class)->make();
        // $backendUser = BackendUser::query()->where('Username', 'admin')->first();
        // $this->token = $jwt->fromUser($backendUser);

        $this->token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZmMzZWRmMS1lZDQyLTExZWMtOTkzZS00MjAxMGE4MjAwMDYiLCJzY29wZXMiOlsiUEVSTUlTU0lPTlM6UkVBRF9VU0VSUyIsIlBFUk1JU1NJT05TOldSSVRFX1VTRVJTIiwiUEVSTUlTU0lPTlM6REVMRVRFX1VTRVJTIiwiUEVSTUlTU0lPTlM6UkVBRF9HUk9VUFMiLCJQRVJNSVNTSU9OUzpXUklURV9HUk9VUFMiLCJQRVJNSVNTSU9OUzpERUxFVEVfR1JPVVBTIiwiUEVSTUlTU0lPTlM6UkVBRF9ST0xFUyIsIlBFUk1JU1NJT05TOldSSVRFX1JPTEVTIiwiUEVSTUlTU0lPTlM6REVMRVRFX1JPTEVTIiwiUEVSTUlTU0lPTlM6UkVBRF9QRVJNSVNTSU9OIiwiUEVSTUlTU0lPTlM6V1JJVEVfUEVSTUlTU0lPTiIsIlBFUk1JU1NJT05TOkRFTEVURV9QRVJNSVNTSU9OIiwiU1lTVEVNX1NFVFRJTkc6UkVBRF9TWVNURU1fU0VUVElORyIsIlNZU1RFTV9TRVRUSU5HOlJFQURfU1lTVEVNX1NFVFRJTkdfREVGSU5JVElPTiIsIk1FUkNIQU5ULUNFTlRFUjpSRUFEX0RBU0hCT0FSRCIsIk1FUkNIQU5ULUNFTlRFUjpNT0RJRllfU0VDVVJFX1NFVFRJTkciLCJNRVJDSEFOVC1DRU5URVI6UkVBRF9XQUxMRVQiLCJQRVJNSVNTSU9OUzpSRUFEX1BST1hZIiwiUEVSTUlTU0lPTlM6V1JJVEVfUFJPWFkiLCJQRVJNSVNTSU9OUzpERUxFVEVfUFJPWFkiLCJNRVJDSEFOVC1QRVJNSVNTSU9OOlJFQURfTUVSQ0hBTlRfVVNFUlMiLCJNRVJDSEFOVC1QRVJNSVNTSU9OOldSSVRFX01FUkNIQU5UX1VTRVJTIiwiTUVSQ0hBTlQtUEVSTUlTU0lPTjpERUxFVEVfTUVSQ0hBTlRfVVNFUlMiLCJNRVJDSEFOVC1QRVJNSVNTSU9OOlJFQURfTUVSQ0hBTlRfR1JPVVBTIiwiTUVSQ0hBTlQtUEVSTUlTU0lPTjpXUklURV9NRVJDSEFOVF9HUk9VUFMiLCJNRVJDSEFOVC1QRVJNSVNTSU9OOkRFTEVURV9NRVJDSEFOVF9HUk9VUFMiLCJNRVJDSEFOVC1QRVJNSVNTSU9OOlJFQURfTUVSQ0hBTlRfUk9MRVMiLCJNRVJDSEFOVC1QRVJNSVNTSU9OOldSSVRFX01FUkNIQU5UX1JPTEVTIiwiTUVSQ0hBTlQtUEVSTUlTU0lPTjpERUxFVEVfTUVSQ0hBTlRfUk9MRVMiLCJNRVJDSEFOVC1QRVJNSVNTSU9OOlJFQURfTUVSQ0hBTlRfUEVSTUlTU0lPTiIsIlBFUk1JU1NJT05TOlJFQURfVVNFUlNfQURNSU4iLCJQRVJNSVNTSU9OUzpSRUFEX0dST1VQU19BRE1JTiIsIk1FUkNIQU5ULVBFUk1JU1NJT046UkVBRF9TWVNURU0iLCJNRVJDSEFOVC1QRVJNSVNTSU9OOldSSVRFX1NZU1RFTSIsIjUwMToxMDAiLCI1MDE6MjAwIiwiNTAxOjMwMiIsIjUwMTozMDEiLCI1MDE6NDAwIiwiNTAxOjQwMSIsIjUwMjoxMDAiLCI1MDI6MjAwIiwiNTAyOjMwMiIsIjUwMjozMDEiLCI1MDI6NDAwIiwiNTAyOjQwMSIsIjUwMzoxMDAiLCI1MDM6MjAwIiwiNTAzOjMwMiIsIjUwMzozMDEiLCI1MDM6NDAwIiwiNTAzOjQwMSIsIjUwMzo0MDkiLCI1MDQ6MTAxIiwiNTA0OjIwMCIsIjUwNDozMDIiLCI1MDQ6MzAxIiwiNTA0OjQwMCIsIjUwNDo0MDEiLCI1Mjg6MjAyIiwiNTI4OjMwMiIsIjUyODozMDEiLCI1MDU6MTAwIiwiNTA1OjIwMCIsIjUwNTozMDIiLCI1MDU6MzAxIiwiNTA1OjQwMCIsIjUwNTo0MDEiLCI1Mjc6MjAwIiwiNTI3OjMwMiIsIjUyNzozMDEiLCI1Mjc6NDAzIiwiNTA2OjEwMCIsIjUwNjoyMDAiLCI1MDY6MzAyIiwiNTA2OjMwMSIsIjUwNjo0MDAiLCI1MDY6NDAxIiwiNTA2OjIwMyIsIjUwNzoxMDAiLCI1MDc6MjAwIiwiNTA3OjMwMiIsIjUwNzozMDEiLCI1MDc6NDAwIiwiNTA3OjQwMSIsIjUwODoxMDAiLCI1MDg6MjAwIiwiNTA4OjMwMiIsIjUwODozMDEiLCI1MDg6NDAwIiwiNTA4OjQwMSIsIjUwODo0MDYiLCI1MDg6MjAzIiwiNTEwOjEwMCIsIjUxMDoyMDAiLCI1MTA6MzAyIiwiNTEwOjMwMSIsIjUxMDo0MDAiLCI1MTA6NDAxIiwiNTExOjEwMCIsIjUxMToyMDAiLCI1MTE6MzAyIiwiNTExOjMwMSIsIjUxMTo0MDAiLCI1MTE6NDAxIiwiNTEyOjEwMCIsIjUxMjoyMDAiLCI1MTI6MzAyIiwiNTEyOjMwMSIsIjUxMjo0MDAiLCI1MTI6NDAxIiwiNTM0OjEwMCIsIjUzNDozMDIiLCI1MzQ6MzAxIiwiNTM0OjQwMCIsIjUzNDo0MDEiLCI1MzY6MzAxIiwiNTM2OjMwMiIsIjUxMzoxMDAiLCI1MTM6MjAwIiwiNTEzOjMwMiIsIjUxMzozMDEiLCI1MTM6NDAwIiwiNTEzOjQwMSIsIjUxNDoxMDAiLCI1MTQ6MjAwIiwiNTE0OjMwMiIsIjUxNDozMDEiLCI1MTQ6NDAwIiwiNTE0OjQwMSIsIjUxNTozMDIiLCI1MTU6MzAxIiwiNTE1OjMwNCIsIjUxNTozMDUiLCI1MTU6MzA2IiwiNTE1OjQxNSIsIjUxNTo0MTYiLCI1MTU6NDE3IiwiNTE1OjQxOCIsIjUxNTo0MTkiLCI1MTU6NDAxIiwiNTE1OjQwOCIsIjUxNTozMTEiLCI1MTU6MzEyIiwiNTE3OjEwNSIsIjUxNzozMDIiLCI1MTc6MzAxIiwiNTE3OjMxMSIsIjUxOToxMDMiLCI1MTk6MzAxIiwiNTE5OjMxMSIsIjUyMToxMDAiLCI1MjE6MzAyIiwiNTIxOjMwMSIsIjUyMTozMDkiLCI1MjE6NDAxIiwiNTIxOjQwOSIsIjUyMTo0MTAiLCI1MjE6NDIwIiwiNTIxOjQyMSIsIjUyMTo0MjIiLCI1MjE6NDIzIiwiNTIxOjQyOCIsIjUyMTozMTEiLCI1Mjk6MzAyIiwiNTI5OjMxMCIsIjUzMDozMDIiLCI1MzA6MzAxIiwiNTMwOjEwMyIsIjU0MzozMDEiLCI1NDM6MzAyIiwiNTQzOjMxMSIsIjU0Mzo0MjkiLCI1MjI6MTAwIiwiNTIyOjMwMiIsIjUyMjozMDEiLCI1MjI6NDAxIiwiNTIyOjQxMiIsIjUyMjoyMDAiLCI1MjI6NDAwIiwiNTMyOjEwMCIsIjUzMjozMDIiLCI1MzI6MzAxIiwiNTMyOjQwMCIsIjUzMjo0MDEiLCI1MzE6MTAwIiwiNTMxOjMwMiIsIjUzMTozMDEiLCI1MzE6NDAwIiwiNTMxOjQwMSIsIjUyNDoxMDEiLCI1MjQ6MjAwIiwiNTI0OjMwMiIsIjUyNDozMDEiLCI1MjQ6NDAwIiwiNTI0OjQwMSIsIjUzMzoxMDAiLCI1MzM6MzAxIiwiNTMzOjQwMSIsIjUzMzo0MDAiLCI1MzM6MjAwIiwiNTMzOjMwMiIsIjUzMzozMTQiLCI1Mzg6MzAxIiwiNTM4OjMxMSIsIjUzNzozMDEiLCI1Mzc6MzExIiwiNTQxOjMwMSIsIjU0MTozMTEiLCI1MjA6MTAwIiwiNTIwOjMwMSIsIjUyMDozMDIiLCI1MjA6NDAwIiwiNTIwOjQwMSIsIjUyMDoyMDAiLCI1MTg6MzAyIiwiNTE4OjEwMCIsIjUwOTozMTUiLCI1MDk6MzE2IiwiNTA5OjMxNyIsIjUwOTozMDIiLCI1MDk6MTAwIiwiNTA5OjIwMCIsIjUwOToyMDEiLCI1MDk6MzAzIiwiNTA5OjMxOCIsIjU0MjozMDEiLCI1NDQ6MzAxIiwiNTQ1OjMwMSIsIjU0NTozMDIiLCI1NDU6NDMwIiwiNTIxOjEwNiIsIjU0ODozMDEiLCI1NDg6MjAwIiwiNTQ4OjMwMiIsIjU0ODo0MDAiLCI1NDg6NDAxIiwiNTQ3OjMwMSIsIjU0NzozMTEiLCI1NDY6MzIxIiwiNTQ2OjMyMiIsIjU0NjozMjMiLCI1NDY6MzI0IiwiNTQ2OjMyNSIsIjU0NjozMjYiLCI1NDk6MzAxIiwiNTQ5OjMxMSIsIjU1MDoxMDAiLCI1NTA6MzExIiwiNTUwOjMwMiIsIjU1MDozMDEiLCI1NTA6NDAwIiwiNTUwOjQwMSIsIjU1MDozMjciLCI1NTA6MzI4IiwiNTM0OjIwMCIsIjUzMToyMDAiLCI1NTE6MzAxIiwiNTUxOjMxMSIsIjU1MjoxMDAiLCI1NTI6MjAwIiwiNTUyOjMwMSIsIjU1MzoxMDAiLCI1NTM6MzAyIiwiNTUzOjMwMSIsIjUyMTo0MzEiLCI1NDI6MzExIiwiNTUzOjQwMSIsIjU0NDozMTEiLCI1NTQ6MzAxIiwiNTU0OjMxMSIsIjUzMjoyMDAiLCI1NTc6MzAxIiwiNTU3OjMxMSIsIjUwNzoyMDMiLCI1NTM6MzI5IiwiNTUzOjQzMyIsIjU1OTozMDEiLCI1NTk6MzExIiwiNTUzOjMzMCIsIlBFUk1JU1NJT05TOkdPT0dMRV9BVVRIX0dFTkVSQVRFX1FSQ09ERSIsIlBFUk1JU1NJT05TOkdPT0dMRV9BVVRIX1RPS0VOX1ZFUklGWSIsIjU2MjoxMDAiLCI1NjI6MjAwIiwiNTYyOjMwMSIsIjU2MjozMDIiLCI1NjI6NDAwIiwiNTYzOjMwMSIsIjU2MzozMTEiLCI1NjQ6MzAxIiwiNTY0OjMwMiIsIjU2NDoxMDAiLCI1NjQ6NDAwIiwiNTY0OjQwMSIsIjU2NDoyMDAiLCI1NjE6MzAxIiwiNTYxOjMxMSIsIjU2NTozMDEiLCI1NjU6MzExIiwiNTEyOjIwMyIsIjUzNDoyMDMiLCI1MTE6MjAzIiwiNTY0OjIwMyIsIjU3MzozMDEiLCI1NzM6MzExIiwiNTMxOjMzMSIsIjU3NDozMDEiLCI1NzQ6MzAyIiwiNTc0OjMxMSIsIjUxNTozMzIiLCI1MTU6NDQyIiwiNTc0OjQyOSIsIjU3NDo0MzAiLCI1MTU6NDIxIiwiNTc1OjMwMiIsIjU3NTo0MDAiLCI1NzU6NDAxIiwiNTc3OjEwMCIsIjU3NzoyMDAiLCI1Nzc6MzAxIiwiNTc3OjMwMiIsIjU3Nzo0MDAiLCI1Nzc6NDAxIiwiNTc3OjQ0MyIsIjU3NzoyMDMiLCI1Nzk6MzAxIiwiNTc5OjMxMSIsIjU3ODozMDEiLCI1Nzg6MzExIiwiNTc1OjIwMyIsIjU4MDozMDIiLCI1ODA6MzAxIiwiNTgwOjQwMCIsIjU4MToxMDAiLCI1ODE6MzAxIiwiNTgxOjMwMiIsIjU0NjozMzMiLCI1NzY6MzM0IiwiNTc2OjQ0NCIsIjUzMTozMzUiLCI1NzQ6MzM2IiwiNTc0OjMyOSIsIjU3NDo0MzMiLCI1ODM6MTAwIiwiNTgzOjEwNyIsIjU4MzozMDEiLCI1ODM6MzExIiwiNTg0OjMwMSIsIjU4NDozMTEiLCI1NzY6MzM4IiwiNTE1OjQyMCIsIjU4NTo0MzAiLCI1ODU6MzAxIiwiNTg1OjMxMSIsIjU4NTozMDIiLCI1ODU6MzI5IiwiNTg1OjQzNCIsIjU4MjoxMDAiLCI1ODI6MjAwIiwiNTgyOjMwMSIsIjU4MjozMDIiLCI1ODI6NDAwIiwiNTgyOjQwMSIsIjU4NjozMTEiLCI1NzQ6NDQ1IiwiNTg3OjEwMCIsIjU4NzozMDEiLCI1ODc6MzAyIiwiNTg3OjQwMCIsIjU4Nzo0MDEiLCI1ODY6MzAyIiwiNTA0OjQ0NiIsIjU1MzoyMDMiLCI1ODc6MjAzIiwiNTIxOjMzOSIsIjU4ODoxMDAiLCI1ODg6MjAzIiwiNTg4OjMwMSIsIjU4ODozMDIiLCI1ODg6NDAwIiwiNTg4OjQwMSIsIjU5MDozMDEiLCI1OTE6MTAwIiwiNTkxOjIwMCIsIjU5MTozMDEiLCI1OTE6NDAwIiwiNTkyOjMwMSIsIjU5MzoxMDAiLCI1OTM6MjAwIiwiNTkzOjMwMSIsIjU5Mzo0MDEiLCI1OTQ6MTAwIiwiNTk0OjIwMCIsIjU5NDozMDEiLCI1OTQ6NDAxIiwiNTk2OjEwMCIsIjU5NjoyMDAiLCI1OTY6MzAxIiwiNTk2OjQwMCIsIjU5NzoxMDAiLCI1OTc6MjAwIiwiNTk3OjMwMSIsIjU5Nzo0MDAiLCI1OTU6MTAwIiwiNTk1OjIwMCIsIjU5NTozMDEiLCI1OTU6NDAxIiwiNTkyOjQwMSIsIjUwMToyMDMiLCI1MDI6MjAzIiwiNTAzOjIwMyIsIjUwNDoyMDMiLCI1MTA6MjAzIiwiNTI0OjIwMyIsIjUyMjoyMDMiLCI1MDg6NDQ4IiwiQ09NTUVOVFM6UkVBRCIsIkNPTU1FTlRTOldSSVRFIiwiQ09NTUVOVFM6REVMRVRFIiwiQ09NTUVOVF9CQU5fVVNFUlM6UkVBRCIsIkNPTU1FTlRfQkFOX1VTRVJTOldSSVRFIiwiQ09NTUVOVF9CQU5fVVNFUlM6REVMRVRFIl0sImlhdCI6MTY5MDM0MjY1M30.7U3NYFmruM1ssO0N6F9Gn7ug8Q2pFoOBpKMICMF3Kq0';
    }
}
